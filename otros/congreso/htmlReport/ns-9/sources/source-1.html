


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > PointsBatchConfig</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.proyecto.congreso.pases.batch.config</a>
</div>

<h1>Coverage Summary for Class: PointsBatchConfig (com.proyecto.congreso.pases.batch.config)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">PointsBatchConfig</td>
<td class="coverageStat">
  <span class="percent">
    50%
  </span>
  <span class="absValue">
    (6/12)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    5.6%
  </span>
  <span class="absValue">
    (1/18)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    28.9%
  </span>
  <span class="absValue">
    (22/76)
  </span>
</td>
</tr>
  <tr>
    <td class="name">PointsBatchConfig$$SpringCGLIB$$0</td>
  </tr>
  <tr>
    <td class="name">PointsBatchConfig$$SpringCGLIB$$FastClass$$0</td>
  </tr>
  <tr>
    <td class="name">PointsBatchConfig$$SpringCGLIB$$FastClass$$1</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    50%
  </span>
  <span class="absValue">
    (6/12)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    5.6%
  </span>
  <span class="absValue">
    (1/18)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    28.9%
  </span>
  <span class="absValue">
    (22/76)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.proyecto.congreso.pases.batch.config;
&nbsp;
&nbsp;import com.proyecto.congreso.points.assistance.model.Asistencia;
&nbsp;import com.proyecto.congreso.points.assistance.repository.AsistenciaRepository;
&nbsp;import com.proyecto.congreso.points.assistance.dto.AsistenciaPointsData;
&nbsp;import com.proyecto.congreso.pases.batch.listener.BatchJobExecutionMongoListener;
&nbsp;import com.proyecto.congreso.pases.model.Pass;
&nbsp;import com.proyecto.congreso.pases.repository.PassRepository;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.springframework.batch.core.Job;
&nbsp;import org.springframework.batch.core.Step;
&nbsp;import org.springframework.batch.core.job.builder.JobBuilder;
&nbsp;import org.springframework.batch.core.repository.JobRepository;
&nbsp;import org.springframework.batch.core.step.builder.StepBuilder;
&nbsp;import org.springframework.batch.item.ItemProcessor;
&nbsp;import org.springframework.batch.item.ItemWriter;
&nbsp;import org.springframework.batch.item.data.RepositoryItemReader;
&nbsp;import org.springframework.batch.item.data.builder.RepositoryItemReaderBuilder;
&nbsp;import org.springframework.beans.factory.annotation.Autowired;
&nbsp;import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
&nbsp;import org.springframework.context.annotation.Bean;
&nbsp;import org.springframework.context.annotation.Configuration;
&nbsp;import org.springframework.data.domain.Sort;
&nbsp;import org.springframework.transaction.PlatformTransactionManager;
&nbsp;
&nbsp;import java.time.LocalDateTime;
&nbsp;import java.util.Collections;
&nbsp;import java.util.Optional;
&nbsp;
&nbsp;/**
&nbsp; * Configuraci√≥n de Spring Batch para el procesamiento diario de puntos.
&nbsp; *
&nbsp; * Job: addJob y useJob
&nbsp; * Step 1: calculatePoints - Lee pases, calcula y agrega puntos.
&nbsp; * Step 2: publishEventsStep - Publica eventos para logs en MongoDB
&nbsp; Job: pointsJob
&nbsp; * Step: calculateAndApplyPointsStep - Lee pases activos, calcula y publica eventos
&nbsp;
&nbsp;**
&nbsp;        * ‚úÖ CORREGIDO: Configuraci√≥n de Spring Batch para procesamiento de asistencias.
&nbsp;        *
&nbsp;        * JOB: processAssistancePointsJob
&nbsp; * - Lee asistencias pendientes desde MongoDB
&nbsp; * - Suma puntos en Pass (MySQL)
&nbsp; * - Marca asistencias como procesadas
&nbsp; *
&nbsp;         * CASO DE USO:
&nbsp;        * - Procesar asistencias que se registraron pero no sumaron puntos
&nbsp; *   (por fallos de red, timeouts, etc.)
&nbsp;        * - Ejecutar diariamente o bajo demanda
&nbsp; */
<b class="fc">&nbsp;@Slf4j</b>
&nbsp;@Configuration
&nbsp;@RequiredArgsConstructor
&nbsp;@ConditionalOnProperty(name = &quot;spring.batch.job.enabled&quot;, havingValue = &quot;true&quot;, matchIfMissing = true)
&nbsp;
&nbsp;public class PointsBatchConfig {
&nbsp;
&nbsp;    private final JobRepository jobRepository;
&nbsp;    private final PlatformTransactionManager transactionManager;
&nbsp;    private final PassRepository passRepository;
&nbsp;    private final AsistenciaRepository asistenciaRepository;
&nbsp;
&nbsp;    @Autowired(required = false)
&nbsp;    private BatchJobExecutionMongoListener batchJobExecutionMongoListener;
&nbsp;
&nbsp;    // ========== JOB DEFINITION ==========
&nbsp;
&nbsp;    /**
&nbsp;     * Job que procesa asistencias pendientes y suma puntos.
&nbsp;     */
&nbsp;    @Bean
&nbsp;    public Job processAssistancePointsJob() {
<b class="fc">&nbsp;        JobBuilder jobBuilder = new JobBuilder(&quot;processAssistancePointsJob&quot;, jobRepository);</b>
&nbsp;
&nbsp;        // Add MongoDB listener if available
<b class="pc">&nbsp;        if (batchJobExecutionMongoListener != null) {</b>
<b class="nc">&nbsp;            jobBuilder.listener(batchJobExecutionMongoListener);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        return jobBuilder</b>
<b class="fc">&nbsp;                .start(processAssistancesStep())</b>
<b class="fc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    // ========== STEP: PROCESS ASSISTANCES ==========
&nbsp;
&nbsp;    @Bean
&nbsp;    public Step processAssistancesStep() {
<b class="fc">&nbsp;        return new StepBuilder(&quot;processAssistancesStep&quot;, jobRepository)</b>
<b class="fc">&nbsp;                .&lt;Asistencia, AsistenciaPointsData&gt;chunk(10, transactionManager)  // ‚Üê CAMBIO: AsistenciaPointsData</b>
<b class="fc">&nbsp;                .reader(pendingAssistancesReader())</b>
<b class="fc">&nbsp;                .processor(assistancePointsProcessor())</b>
<b class="fc">&nbsp;                .writer(pointsUpdaterWriter())</b>
<b class="fc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    // ---------- READER: Lee asistencias pendientes de MongoDB -----------
&nbsp;
&nbsp;    @Bean
&nbsp;    public RepositoryItemReader&lt;Asistencia&gt; pendingAssistancesReader() {
<b class="fc">&nbsp;        return new RepositoryItemReaderBuilder&lt;Asistencia&gt;()</b>
<b class="fc">&nbsp;                .name(&quot;pendingAssistancesReader&quot;)</b>
<b class="fc">&nbsp;                .repository(asistenciaRepository)</b>
<b class="fc">&nbsp;                .methodName(&quot;findByStatus&quot;) // Busca asistencias &quot;PENDIENTE&quot;</b>
<b class="fc">&nbsp;                .arguments(&quot;PENDIENTE&quot;)</b>
<b class="fc">&nbsp;                .sorts(Collections.singletonMap(&quot;fechaAsistencia&quot;, Sort.Direction.ASC))</b>
<b class="fc">&nbsp;                .pageSize(10)</b>
<b class="fc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    // ---------- PROCESSOR: Valida Pass y prepara datos -----------
&nbsp;
&nbsp;    @Bean
&nbsp;    public ItemProcessor&lt;Asistencia, AsistenciaPointsData&gt; assistancePointsProcessor() {
<b class="fc">&nbsp;        return asistencia -&gt; {</b>
<b class="nc">&nbsp;            log.info(&quot;üìä Procesando asistencia: Pass={}, Conferencia={}, Puntos={}&quot;,</b>
<b class="nc">&nbsp;                    asistencia.getPassId(),</b>
<b class="nc">&nbsp;                    asistencia.getConferenciaId(),</b>
<b class="nc">&nbsp;                    asistencia.getPuntosOtorgados());</b>
&nbsp;
&nbsp;            // Validar que el Pass existe y est√° activo
<b class="nc">&nbsp;            Optional&lt;Pass&gt; optionalPass = passRepository.findById(asistencia.getPassId());</b>
<b class="nc">&nbsp;            if (optionalPass.isEmpty()) {</b>
<b class="nc">&nbsp;                log.error(&quot;‚ùå Pass ID {} no encontrado. Omitiendo asistencia.&quot;,</b>
<b class="nc">&nbsp;                        asistencia.getPassId());</b>
<b class="nc">&nbsp;                return null; // Skip this item</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            Pass pass = optionalPass.get();</b>
<b class="nc">&nbsp;            if (pass.getStatus() != Pass.PassStatus.ACTIVE) {</b>
<b class="nc">&nbsp;                log.warn(&quot;‚ö†Ô∏è Pass ID {} no est√° activo. Estado: {}. Omitiendo.&quot;,</b>
<b class="nc">&nbsp;                        pass.getPassId(), pass.getStatus());</b>
<b class="nc">&nbsp;                return null; // Skip this item</b>
&nbsp;            }
&nbsp;
&nbsp;            // Preparar datos para el writer
<b class="nc">&nbsp;            return new AsistenciaPointsData(</b>
<b class="nc">&nbsp;                    asistencia.getId(),</b>
<b class="nc">&nbsp;                    asistencia.getPassId(),</b>
<b class="nc">&nbsp;                    asistencia.getConferenciaId(),</b>
<b class="nc">&nbsp;                    asistencia.getPuntosOtorgados(),</b>
<b class="nc">&nbsp;                    pass.getPointsBalance(),</b>
<b class="nc">&nbsp;                    pass.getPointsBalance() + asistencia.getPuntosOtorgados()</b>
&nbsp;            );
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;    // ---------- WRITER: Suma puntos en MySQL y marca como procesada -----------
&nbsp;
&nbsp;    @Bean
&nbsp;    public ItemWriter&lt;AsistenciaPointsData&gt; pointsUpdaterWriter() {
<b class="fc">&nbsp;        return items -&gt; {</b>
<b class="nc">&nbsp;            for (AsistenciaPointsData data : items) {</b>
<b class="nc">&nbsp;                if (data == null) continue;</b>
&nbsp;
&nbsp;                try {
&nbsp;                    // 1. Actualizar Pass en MySQL
<b class="nc">&nbsp;                    Pass pass = passRepository.findById(data.getPassId())</b>
<b class="nc">&nbsp;                            .orElseThrow(() -&gt; new IllegalStateException(</b>
<b class="nc">&nbsp;                                    &quot;Pass not found: &quot; + data.getPassId()));</b>
&nbsp;
<b class="nc">&nbsp;                    Integer balanceAnterior = pass.getPointsBalance();</b>
<b class="nc">&nbsp;                    Integer nuevoBalance = balanceAnterior + data.getPointsAwarded();</b>
&nbsp;
<b class="nc">&nbsp;                    pass.setPointsBalance(nuevoBalance);</b>
<b class="nc">&nbsp;                    pass.setPointsAdd(Pass.PointsMovementAdd.ADD);</b>
<b class="nc">&nbsp;                    pass.setUpdatedAt(LocalDateTime.now());</b>
&nbsp;
&nbsp;                    // Verificar logros
<b class="nc">&nbsp;                    checkAchievements(pass, balanceAnterior, nuevoBalance);</b>
&nbsp;
<b class="nc">&nbsp;                    passRepository.save(pass);</b>
&nbsp;
&nbsp;                    // 2. Marcar asistencia como PROCESADA en MongoDB
<b class="nc">&nbsp;                    Asistencia asistencia = asistenciaRepository.findById(data.getAsistenciaId())</b>
<b class="nc">&nbsp;                            .orElseThrow(() -&gt; new IllegalStateException(</b>
<b class="nc">&nbsp;                                    &quot;Asistencia not found: &quot; + data.getAsistenciaId()));</b>
&nbsp;
<b class="nc">&nbsp;                    asistencia.setStatus(&quot;PROCESADA&quot;);</b>
<b class="nc">&nbsp;                    asistencia.setParticipantId(pass.getParticipantId()); // Actualizar participantId</b>
<b class="nc">&nbsp;                    asistenciaRepository.save(asistencia);</b>
&nbsp;
<b class="nc">&nbsp;                    log.info(&quot;‚úÖ Asistencia procesada exitosamente: Pass={}, Puntos a√±adidos={}, Nuevo balance={}&quot;,</b>
<b class="nc">&nbsp;                            data.getPassId(), data.getPointsAwarded(), nuevoBalance);</b>
&nbsp;
&nbsp;                } catch (Exception e) {
<b class="nc">&nbsp;                    log.error(&quot;‚ùå Error procesando asistencia: {}&quot;, data, e);</b>
&nbsp;
&nbsp;                    // Marcar como FALLIDA
<b class="nc">&nbsp;                    asistenciaRepository.findById(data.getAsistenciaId()).ifPresent(a -&gt; {</b>
<b class="nc">&nbsp;                        a.setStatus(&quot;FALLIDA&quot;);</b>
<b class="nc">&nbsp;                        asistenciaRepository.save(a);</b>
&nbsp;                    });
&nbsp;                }
&nbsp;            }
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;    // ---------- HELPER: Verificar logros -----------
&nbsp;
&nbsp;    private void checkAchievements(Pass pass, Integer oldBalance, Integer newBalance) {
&nbsp;        // Certificado (25 puntos)
<b class="nc">&nbsp;        if (oldBalance &lt; pass.getPointsCertificate() &amp;&amp;</b>
<b class="nc">&nbsp;                newBalance &gt;= pass.getPointsCertificate()) {</b>
<b class="nc">&nbsp;            pass.setCertificateStatus(Pass.CertificateStatus.REACHED);</b>
<b class="nc">&nbsp;            log.info(&quot;üèÜ Certificado alcanzado: Pass ID {}&quot;, pass.getPassId());</b>
&nbsp;        }
&nbsp;
&nbsp;        // Acceso Especial (30 puntos)
<b class="nc">&nbsp;        if (oldBalance &lt; pass.getPointsSpecialAccess() &amp;&amp;</b>
<b class="nc">&nbsp;                newBalance &gt;= pass.getPointsSpecialAccess()) {</b>
<b class="nc">&nbsp;            pass.setAccessStatus(Pass.AccessStatus.REACHED);</b>
<b class="nc">&nbsp;            log.info(&quot;üèÜ Acceso Especial alcanzado: Pass ID {}&quot;, pass.getPassId());</b>
&nbsp;        }
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-10-05 21:51</div>
</div>
</body>
</html>
