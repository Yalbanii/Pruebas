


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > PassPointsEventHandler</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.proyecto.congreso.pases.service</a>
</div>

<h1>Coverage Summary for Class: PassPointsEventHandler (com.proyecto.congreso.pases.service)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">PassPointsEventHandler</td>
<td class="coverageStat">
  <span class="percent">
    46.2%
  </span>
  <span class="absValue">
    (6/13)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    54.5%
  </span>
  <span class="absValue">
    (12/22)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    46.5%
  </span>
  <span class="absValue">
    (66/142)
  </span>
</td>
</tr>
  <tr>
    <td class="name">PassPointsEventHandler$$SpringCGLIB$$0</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    46.2%
  </span>
  <span class="absValue">
    (6/13)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    54.5%
  </span>
  <span class="absValue">
    (12/22)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    46.5%
  </span>
  <span class="absValue">
    (66/142)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.proyecto.congreso.pases.service;
&nbsp;
&nbsp;import com.proyecto.congreso.participantes.model.Participant;
&nbsp;import com.proyecto.congreso.participantes.repository.ParticipantRepository;
&nbsp;import com.proyecto.congreso.pases.events.SpecialAccessEvent;
&nbsp;import com.proyecto.congreso.pases.model.Certificate;
&nbsp;import com.proyecto.congreso.pases.model.Pass;
&nbsp;import com.proyecto.congreso.pases.model.SpecialAccess;
&nbsp;import com.proyecto.congreso.pases.repository.CertificateRepository;
&nbsp;import com.proyecto.congreso.pases.repository.PassRepository;
&nbsp;import com.proyecto.congreso.pases.repository.SpecialAccessRepository;
&nbsp;import com.proyecto.congreso.points.assistance.events.AssistanceRegisteredEvent;
&nbsp;import com.proyecto.congreso.pases.events.CertificateEvent;
&nbsp;import com.proyecto.congreso.points.calculator.repository.FreebieRepository;
&nbsp;import com.proyecto.congreso.points.exchange.events.ExchangeFailedEvent;
&nbsp;import com.proyecto.congreso.points.exchange.events.ExchangeRegisteredEvent;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.springframework.context.ApplicationEventPublisher;
&nbsp;import org.springframework.context.event.EventListener;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.springframework.transaction.annotation.Transactional;
&nbsp;
&nbsp;import java.time.LocalDateTime;
&nbsp;
&nbsp;@Service
<b class="fc">&nbsp;@Slf4j</b>
&nbsp;@RequiredArgsConstructor
&nbsp;public class PassPointsEventHandler {
&nbsp;
&nbsp;    private final PassRepository passRepository;
&nbsp;    private final FreebieRepository freebieRepository;
&nbsp;    private final ParticipantRepository participantRepository;
&nbsp;    private final CertificateRepository certificateRepository;
&nbsp;    private final SpecialAccessRepository specialAccessRepository;
&nbsp;    private final ApplicationEventPublisher eventPublisher;
&nbsp;
&nbsp;    // ========== SUMAR PUNTOS (Asistencias) ==========
&nbsp;    @EventListener
&nbsp;    @Transactional
&nbsp;    public void handleAssistanceRegistered(AssistanceRegisteredEvent event) {
<b class="fc">&nbsp;        log.info(&quot;Evento recibido: AssistanceRegisteredEvent - Pass={}, Puntos={}&quot;,</b>
<b class="fc">&nbsp;                event.getPassId(), event.getAmountPoints());</b>
&nbsp;
&nbsp;        try {
&nbsp;            // 1. Buscar el Pass
<b class="fc">&nbsp;            Pass pass = passRepository.findById(event.getPassId())</b>
<b class="fc">&nbsp;                    .orElseThrow(() -&gt; {</b>
<b class="nc">&nbsp;                        log.error(&quot;‚ùå Pass no encontrado: {}&quot;, event.getPassId());</b>
<b class="nc">&nbsp;                        return new IllegalArgumentException(&quot;Pass not found: &quot; + event.getPassId());</b>
&nbsp;                    });
&nbsp;
&nbsp;            // 2. Validar que el Pass est√© activo
<b class="pc">&nbsp;            if (pass.getStatus() != Pass.PassStatus.ACTIVE) {</b>
<b class="nc">&nbsp;                log.warn(&quot;Pass {} no esta activo. Estado: {}. No se suman puntos.&quot;,</b>
<b class="nc">&nbsp;                        pass.getPassId(), pass.getStatus());</b>
&nbsp;                return;
&nbsp;            }
&nbsp;
&nbsp;            // 3. Guardar balance anterior para logs
<b class="fc">&nbsp;            Integer balanceAnterior = pass.getPointsBalance();</b>
&nbsp;
&nbsp;            // 4. Sumar puntos
<b class="fc">&nbsp;            Integer nuevoBalance = balanceAnterior + event.getAmountPoints();</b>
<b class="fc">&nbsp;            pass.setPointsBalance(nuevoBalance);</b>
<b class="fc">&nbsp;            pass.setPointsAdd(Pass.PointsMovementAdd.ADD);</b>
<b class="fc">&nbsp;            pass.setUpdatedAt(LocalDateTime.now());</b>
&nbsp;
&nbsp;            // 5. Verificar logros (certificado y acceso especial)
<b class="fc">&nbsp;            checkAchievements(pass, balanceAnterior, nuevoBalance);</b>
&nbsp;
&nbsp;            // 6. Guardar en MySQL
<b class="fc">&nbsp;            passRepository.save(pass);</b>
&nbsp;
<b class="fc">&nbsp;            log.info(&quot;‚úÖ Puntos sumados exitosamente: Pass={}, Puntos={}, Balance: {} ‚Üí {}&quot;,</b>
<b class="fc">&nbsp;                    pass.getPassId(), event.getAmountPoints(), balanceAnterior, nuevoBalance);</b>
&nbsp;
&nbsp;        } catch (Exception e) {
<b class="fc">&nbsp;            log.error(&quot;‚ùå Error procesando AssistanceRegisteredEvent: {}&quot;, event, e);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    // ========== DESCONTAR PUNTOS (Intercambios) ==========
&nbsp;    @EventListener
&nbsp;    @Transactional
&nbsp;    public void handleExchangeRegistered(ExchangeRegisteredEvent event) {
<b class="nc">&nbsp;        log.info(&quot;üì• Evento recibido: ExchangeRegisteredEvent - Pass={}, Puntos={}&quot;,</b>
<b class="nc">&nbsp;                event.getPassId(), event.getCosto());</b>
&nbsp;
&nbsp;        try {
&nbsp;            // 1. Buscar el Pass
<b class="nc">&nbsp;            Pass pass = passRepository.findById(event.getPassId())</b>
<b class="nc">&nbsp;                    .orElseThrow(() -&gt; {</b>
<b class="nc">&nbsp;                        log.error(&quot;‚ùå Pass no encontrado: {}&quot;, event.getPassId());</b>
<b class="nc">&nbsp;                        return new IllegalArgumentException(&quot;Pass not found: &quot; + event.getPassId());</b>
&nbsp;                    });
&nbsp;
&nbsp;            // 2. Validar que el Pass est√© activo
<b class="nc">&nbsp;            if (pass.getStatus() != Pass.PassStatus.ACTIVE) {</b>
<b class="nc">&nbsp;                log.warn(&quot;‚ö†Ô∏è Pass {} no esta activo. Estado: {}. No se descuentan puntos.&quot;,</b>
<b class="nc">&nbsp;                        pass.getPassId(), pass.getStatus());</b>
&nbsp;
&nbsp;                // Publicar evento de fallo
<b class="nc">&nbsp;                eventPublisher.publishEvent(new ExchangeFailedEvent(</b>
<b class="nc">&nbsp;                        event.getPassId(),</b>
&nbsp;                        &quot;El Pass no esta activo&quot;
&nbsp;                ));
&nbsp;                return;
&nbsp;            }
&nbsp;
&nbsp;            // 3. Validar puntos suficientes
<b class="nc">&nbsp;            if (pass.getPointsBalance() &lt; event.getCosto()) {</b>
<b class="nc">&nbsp;                log.error(&quot;‚ùå Puntos insuficientes. Balance: {}, Costo: {}&quot;,</b>
<b class="nc">&nbsp;                        pass.getPointsBalance(), event.getCosto());</b>
&nbsp;
&nbsp;                // Publicar evento de fallo para evitar que se reduzca el stock sin intercambios
<b class="nc">&nbsp;                eventPublisher.publishEvent(new ExchangeFailedEvent(</b>
<b class="nc">&nbsp;                        event.getPassId(),</b>
<b class="nc">&nbsp;                        String.format(&quot;Puntos insuficientes. Necesitas %d, tienes %d&quot;,</b>
<b class="nc">&nbsp;                                event.getCosto(), pass.getPointsBalance())</b>
&nbsp;                ));
&nbsp;                return;
&nbsp;            }
&nbsp;
&nbsp;            // 4. Descontar puntos
<b class="nc">&nbsp;            Integer balanceAnterior = pass.getPointsBalance();</b>
<b class="nc">&nbsp;            Integer nuevoBalance = balanceAnterior - event.getCosto();</b>
&nbsp;
<b class="nc">&nbsp;            pass.setPointsBalance(nuevoBalance);</b>
<b class="nc">&nbsp;            pass.setPointsUse(Pass.PointsMovementUse.USE);</b>
<b class="nc">&nbsp;            pass.setUpdatedAt(LocalDateTime.now());</b>
&nbsp;
&nbsp;            // 5. Guardar en MySQL
<b class="nc">&nbsp;            passRepository.save(pass);</b>
&nbsp;
<b class="nc">&nbsp;            log.info(&quot;‚úÖ Puntos descontados exitosamente: Pass={}, Puntos={}, Balance: {} ‚Üí {}&quot;,</b>
<b class="nc">&nbsp;                    pass.getPassId(), event.getCosto(), balanceAnterior, nuevoBalance);</b>
&nbsp;
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            log.error(&quot;‚ùå Error procesando ExchangeRegisteredEvent: {}&quot;, event, e);</b>
&nbsp;
&nbsp;            // Publicar evento de fallo
<b class="nc">&nbsp;            eventPublisher.publishEvent(new ExchangeFailedEvent(</b>
<b class="nc">&nbsp;                    event.getPassId(),</b>
<b class="nc">&nbsp;                    &quot;Error interno al descontar puntos: &quot; + e.getMessage()</b>
&nbsp;            ));
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    // ========== MANEJO DE FALLOS EN INTERCAMBIOS ==========
&nbsp;    @EventListener
&nbsp;    @Transactional
&nbsp;    public void handleExchangeFailed(ExchangeFailedEvent event) {
<b class="nc">&nbsp;        log.error(&quot;Evento recibido: ExchangeFailedEvent - Pass={}, Raz√≥n={}&quot;,</b>
<b class="nc">&nbsp;                event.getPassId(), event.getReason());</b>
&nbsp;
<b class="nc">&nbsp;        log.info(&quot;Intenta de nuevo&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    // ========== VERIFICACI√ìN Y PUBLICACI√ìN DE LOGROS ==========
&nbsp;    private void checkAchievements(Pass pass, Integer oldBalance, Integer newBalance) {
&nbsp;
&nbsp;        // ========== CERTIFICADO (25 puntos) ==========
<b class="fc">&nbsp;        if (oldBalance &lt; pass.getPointsCertificate() &amp;&amp;</b>
<b class="fc">&nbsp;                newBalance &gt;= pass.getPointsCertificate() &amp;&amp;</b>
<b class="pc">&nbsp;                pass.getCertificateStatus() == Pass.CertificateStatus.NOT_REACHED) {</b>
&nbsp;
<b class="fc">&nbsp;            pass.setCertificateStatus(Pass.CertificateStatus.REACHED);</b>
<b class="fc">&nbsp;            log.info(&quot;üèÜ LOGRO DESBLOQUEADO: Certificado alcanzado! Pass ID: {}, Puntos: {}&quot;,</b>
<b class="fc">&nbsp;                    pass.getPassId(), newBalance);</b>
&nbsp;
&nbsp;            try {
<b class="fc">&nbsp;                CertificateEvent certificateEvent = new CertificateEvent(pass.getPassId());</b>
<b class="fc">&nbsp;                eventPublisher.publishEvent(certificateEvent);</b>
&nbsp;
<b class="fc">&nbsp;                log.info(&quot;üì¢ Evento CertificateEvent publicado: Pass={}, Puntos={}&quot;,</b>
<b class="fc">&nbsp;                        pass.getPassId(), newBalance);</b>
&nbsp;
&nbsp;            } catch (Exception e) {
<b class="nc">&nbsp;                log.error(&quot;‚ùå Error al publicar evento de certificado para Pass: {}&quot;,</b>
<b class="nc">&nbsp;                        pass.getPassId(), e);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        // ========== ACCESO ESPECIAL (30 puntos) ==========
<b class="pc">&nbsp;        if (oldBalance &lt; pass.getPointsSpecialAccess() &amp;&amp;</b>
<b class="fc">&nbsp;                newBalance &gt;= pass.getPointsSpecialAccess() &amp;&amp;</b>
<b class="pc">&nbsp;                pass.getAccessStatus() == Pass.AccessStatus.NOT_REACHED) {</b>
&nbsp;
<b class="fc">&nbsp;            pass.setAccessStatus(Pass.AccessStatus.REACHED);</b>
<b class="fc">&nbsp;            log.info(&quot;üéâ LOGRO DESBLOQUEADO: Acceso Especial alcanzado! Pass ID: {}, Puntos: {}&quot;,</b>
<b class="fc">&nbsp;                    pass.getPassId(), newBalance);</b>
&nbsp;
&nbsp;            try {
<b class="fc">&nbsp;                Participant participant = participantRepository.findById(pass.getParticipantId())</b>
<b class="fc">&nbsp;                        .orElseThrow(() -&gt; new IllegalArgumentException(</b>
<b class="fc">&nbsp;                                &quot;Participante no encontrado: &quot; + pass.getParticipantId()));</b>
&nbsp;
<b class="nc">&nbsp;                SpecialAccessEvent accessEvent = new SpecialAccessEvent(</b>
<b class="nc">&nbsp;                        pass.getPassId(),</b>
<b class="nc">&nbsp;                        participant.getParticipantId(),</b>
<b class="nc">&nbsp;                        participant.getName() + &quot; &quot; + participant.getLastName(),</b>
<b class="nc">&nbsp;                        participant.getEmail()</b>
&nbsp;                );
<b class="nc">&nbsp;                eventPublisher.publishEvent(accessEvent);</b>
&nbsp;
<b class="nc">&nbsp;                log.info(&quot;üì¢ Evento SpecialAccessEvent publicado: Pass={}, Puntos={}&quot;,</b>
<b class="nc">&nbsp;                        pass.getPassId(), newBalance);</b>
&nbsp;
&nbsp;            } catch (Exception e) {
<b class="fc">&nbsp;                log.error(&quot;‚ùå Error al publicar evento de acceso especial para Pass: {}&quot;,</b>
<b class="fc">&nbsp;                        pass.getPassId(), e);</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    // ========== LISTENERS DE LOGROS ==========
&nbsp;    @EventListener
&nbsp;    @Transactional
&nbsp;    public void handleCertificateAchieved(CertificateEvent event) {
<b class="fc">&nbsp;        log.info(&quot;Procesando evento de certificado alcanzado: Pass={}&quot;,</b>
<b class="fc">&nbsp;                event.getPassId());</b>
&nbsp;
&nbsp;        try {
<b class="fc">&nbsp;            if (certificateRepository.existsByPassId(event.getPassId())) {</b>
<b class="fc">&nbsp;                log.warn(&quot;‚ö†Ô∏è Ya existe un certificado para el Pass ID: {}. Ignorando evento duplicado.&quot;,</b>
<b class="fc">&nbsp;                        event.getPassId());</b>
&nbsp;                return;
&nbsp;            }
&nbsp;
&nbsp;            // Obtener el Pass para acceder al participantId
<b class="fc">&nbsp;            Pass pass = passRepository.findById(event.getPassId())</b>
<b class="fc">&nbsp;                    .orElseThrow(() -&gt; {</b>
<b class="fc">&nbsp;                        log.error(&quot;‚ùå Pass no encontrado: {}&quot;, event.getPassId());</b>
<b class="fc">&nbsp;                        return new IllegalArgumentException(&quot;Pass no encontrado: &quot; + event.getPassId());</b>
&nbsp;                    });
&nbsp;
&nbsp;            // Obtener el Participante para acceder a nombre y email
<b class="fc">&nbsp;            Participant participant = participantRepository.findById(pass.getParticipantId())</b>
<b class="fc">&nbsp;                    .orElseThrow(() -&gt; {</b>
<b class="nc">&nbsp;                        log.error(&quot;‚ùå Participante no encontrado: {}&quot;, pass.getParticipantId());</b>
<b class="nc">&nbsp;                        return new IllegalArgumentException(</b>
<b class="nc">&nbsp;                                &quot;Participante no encontrado: &quot; + pass.getParticipantId());</b>
&nbsp;                    });
&nbsp;
<b class="fc">&nbsp;            log.info(&quot;Datos obtenidos - Participante: {} {}, Email: {}, Puntos: {}&quot;,</b>
<b class="fc">&nbsp;                    participant.getName(),</b>
<b class="fc">&nbsp;                    participant.getLastName(),</b>
<b class="fc">&nbsp;                    participant.getEmail(),</b>
<b class="fc">&nbsp;                    pass.getPointsBalance());</b>
&nbsp;
&nbsp;            // Crear el certificado usando el factory method
<b class="fc">&nbsp;            Certificate certificate = Certificate.create(</b>
<b class="fc">&nbsp;                    pass.getPassId(),</b>
<b class="fc">&nbsp;                    participant.getParticipantId(),</b>
<b class="fc">&nbsp;                    participant.getEmail(),</b>
<b class="fc">&nbsp;                    participant.getName() + &quot; &quot; + participant.getLastName(),</b>
<b class="fc">&nbsp;                    pass.getPointsBalance()</b>
&nbsp;            );
&nbsp;
&nbsp;            // Guardar en MySQL
<b class="fc">&nbsp;            Certificate savedCertificate = certificateRepository.save(certificate);</b>
&nbsp;
<b class="fc">&nbsp;            log.info(&quot;‚úÖ Certificado creado exitosamente en MySQL: &quot; +</b>
&nbsp;                            &quot;ID={}, Pass={}, C√≥digo={}, Participante={}&quot;,
<b class="fc">&nbsp;                    savedCertificate.getCertificateId(),</b>
<b class="fc">&nbsp;                    savedCertificate.getPassId(),</b>
<b class="fc">&nbsp;                    savedCertificate.getCertificateCode(),</b>
<b class="fc">&nbsp;                    savedCertificate.getParticipantName());</b>
&nbsp;
&nbsp;        } catch (Exception e) {
<b class="fc">&nbsp;            log.error(&quot;‚ùå Error al crear certificado para Pass ID: {}&quot;, event.getPassId(), e);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @EventListener
&nbsp;    @Transactional
&nbsp;    public void handleSpecialAccessAchieved(SpecialAccessEvent event) {
<b class="nc">&nbsp;        log.info(&quot;Procesando evento de acceso especial alcanzado: Pass={}&quot;,</b>
<b class="nc">&nbsp;                event.passId());</b>
&nbsp;
&nbsp;        try {
<b class="nc">&nbsp;            if (specialAccessRepository.existsByPassId(event.passId())) {</b>
<b class="nc">&nbsp;                log.warn(&quot;Ya existe un acceso especial para el Pass ID: {}. Ignorando evento duplicado.&quot;,</b>
<b class="nc">&nbsp;                        event.passId());</b>
&nbsp;                return;
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            Pass pass = passRepository.findById(event.passId())</b>
<b class="nc">&nbsp;                    .orElseThrow(() -&gt; {</b>
<b class="nc">&nbsp;                        log.error(&quot;‚ùå Pass no encontrado: {}&quot;, event.passId());</b>
<b class="nc">&nbsp;                        return new IllegalArgumentException(&quot;Pass no encontrado: &quot; + event.passId());</b>
&nbsp;                    });
&nbsp;
<b class="nc">&nbsp;            log.info(&quot;Datos obtenidos - Participante: {}, Email: {}, Puntos: {}&quot;,</b>
<b class="nc">&nbsp;                    event.fullName(),</b>
<b class="nc">&nbsp;                    event.email(),</b>
<b class="nc">&nbsp;                    pass.getPointsBalance());</b>
&nbsp;
&nbsp;            // Crear el acceso especial usando el factory method
<b class="nc">&nbsp;            SpecialAccess specialAccess = SpecialAccess.create(</b>
<b class="nc">&nbsp;                    pass.getPassId(),</b>
<b class="nc">&nbsp;                    event.participantId(),</b>
<b class="nc">&nbsp;                    event.email(),</b>
<b class="nc">&nbsp;                    event.fullName(),</b>
<b class="nc">&nbsp;                    pass.getPointsBalance()</b>
&nbsp;            );
&nbsp;
<b class="nc">&nbsp;            SpecialAccess savedAccess = specialAccessRepository.save(specialAccess);</b>
&nbsp;
<b class="nc">&nbsp;            log.info(&quot;‚úÖ Acceso Especial creado exitosamente en MySQL: &quot; +</b>
&nbsp;                            &quot;ID={}, Pass={}, C√≥digo={}, Participante={}&quot;,
<b class="nc">&nbsp;                    savedAccess.getAccessId(),</b>
<b class="nc">&nbsp;                    savedAccess.getPassId(),</b>
<b class="nc">&nbsp;                    savedAccess.getAccessCode(),</b>
<b class="nc">&nbsp;                    savedAccess.getParticipantName());</b>
&nbsp;
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            log.error(&quot;‚ùå Error al crear acceso especial para Pass ID: {}&quot;, event.passId(), e);</b>
&nbsp;        }
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-10-05 21:51</div>
</div>
</body>
</html>
